#!/usr/bin/env bash
set -euo pipefail

ENV_FILE="/etc/default/tunneler-client"

# 1. 권한 체크
[[ $EUID -ne 0 ]] && { echo "sudo로 실행하세요."; exit 1; }
[[ -f "$ENV_FILE" ]] || { echo "설정 파일이 없습니다."; exit 1; }

# 2. 설정 로드 (에러 방지를 위해 변수만 추출)
WS_URL=$(grep '^WS_URL=' "$ENV_FILE" | cut -d'=' -f2-)
SUBDOMAIN=$(grep '^SUBDOMAIN=' "$ENV_FILE" | cut -d'=' -f2-)
TOKEN=$(grep '^TOKEN=' "$ENV_FILE" | cut -d'=' -f2-)
EXTRA_ARGS=$(grep '^EXTRA_ARGS=' "$ENV_FILE" | sed 's/^EXTRA_ARGS=//' | sed 's/^"//;s/"$//')

echo "=== Tunneler 매핑 관리 도구 ==="
echo "현재 설정: $EXTRA_ARGS"
echo "--------------------------------"
echo "형식 예시: ssh=127.0.0.1:22 (이름=IP:포트)"
echo "--------------------------------"

read -rp "수정할 HTTP 대상 (예: http://127.0.0.1:80, 삭제는 del, 패스는 Enter): " HTTP_VAL
read -rp "추가할 TCP (예: web=127.0.0.1:80): " TCP_ADD
read -rp "삭제할 TCP 이름 (예: web): " TCP_DEL
read -rp "추가할 UDP (예: dns=127.0.0.1:53): " UDP_ADD
read -rp "삭제할 UDP 이름 (예: dns): " UDP_DEL

NEW_ARGS="$EXTRA_ARGS"

# HTTP 처리
if [[ "$HTTP_VAL" == "del" ]]; then
    NEW_ARGS=$(echo "$NEW_ARGS" | sed -E "s#--http [^ ]*##g")
elif [[ -n "$HTTP_VAL" ]]; then
    NEW_ARGS=$(echo "$NEW_ARGS" | sed -E "s#--http [^ ]*##g")
    NEW_ARGS+=" --http ${HTTP_VAL}"
fi

# TCP 삭제/추가 (콜론을 등호로 자동 교정 로직 포함)
for name in $(echo "${TCP_DEL}" | tr ',' ' '); do
    NEW_ARGS=$(echo "$NEW_ARGS" | sed -E "s#--tcp ${name}=[^ ]*##g")
done
for kv in $(echo "${TCP_ADD}" | tr ',' ' '); do
    # 사용자 실수(콜론)를 등호로 치환
    kv_fixed=$(echo "$kv" | sed 's/:/=/1')
    if [[ "$kv_fixed" == *"="* ]]; then
        name="${kv_fixed%%=*}"
        NEW_ARGS=$(echo "$NEW_ARGS" | sed -E "s#--tcp ${name}=[^ ]*##g")
        NEW_ARGS+=" --tcp ${kv_fixed}"
    fi
done

# UDP 삭제/추가
for name in $(echo "${UDP_DEL}" | tr ',' ' '); do
    NEW_ARGS=$(echo "$NEW_ARGS" | sed -E "s#--udp ${name}=[^ ]*##g")
done
for kv in $(echo "${UDP_ADD}" | tr ',' ' '); do
    kv_fixed=$(echo "$kv" | sed 's/:/=/1')
    if [[ "$kv_fixed" == *"="* ]]; then
        name="${kv_fixed%%=*}"
        NEW_ARGS=$(echo "$NEW_ARGS" | sed -E "s#--udp ${name}=[^ ]*##g")
        NEW_ARGS+=" --udp ${kv_fixed}"
    fi
done

# 3. 깨끗하게 정리 및 저장 (따옴표 필수)
FINAL_ARGS=$(echo "$NEW_ARGS" | xargs)
cat > "$ENV_FILE" <<EOF
WS_URL=$WS_URL
SUBDOMAIN=$SUBDOMAIN
TOKEN=$TOKEN
EXTRA_ARGS="$FINAL_ARGS"
EOF

echo "[정보] 설정을 반영하여 서비스를 재시작합니다..."
systemctl restart tunneler-client
echo "[OK] 매핑 완료! 대시보드를 확인하세요."
