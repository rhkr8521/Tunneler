name: build-and-publish

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Build .deb (amd64 + arm64)
        run: |
          chmod +x packaging/server/rootfs/scripts/build_deb.sh
          VER="${GITHUB_REF_NAME#v}"
          packaging/server/rootfs/scripts/build_deb.sh "$VER" amd64
          packaging/server/rootfs/scripts/build_deb.sh "$VER" arm64

          ls -al dist

      - name: Upload dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-debs
          path: dist/*.deb

      - name: GitHub Release (attach debs)
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.deb

  publish-apt:
    runs-on: ubuntu-24.04
    needs: build
    permissions:
      contents: write   # gh-pages push 필요
    steps:
      # 1) main 체크아웃: 스크립트/packaging 접근용
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
  
      # 2) build job 산출물(dist/*.deb) 다운로드
      - name: Download dist artifact
        uses: actions/download-artifact@v4
        with:
          name: dist-debs
          path: dist
  
      # 3) APT repo 생성 도구 설치
      - name: Install repo tools
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev apt-utils gnupg
  
      # 4) GPG 키 import (Secrets 사용)
      - name: Import GPG key
        env:
          APT_GPG_PRIVATE_KEY: ${{ secrets.APT_GPG_PRIVATE_KEY }}
          APT_GPG_OWNERTRUST: ${{ secrets.APT_GPG_OWNERTRUST }}
        run: |
          # 비어있으면 바로 실패하게
          test -n "$APT_GPG_PRIVATE_KEY"
          test -n "$APT_GPG_OWNERTRUST"
  
          # (중요) echo는 줄바꿈 보존 위해 printf 사용 권장
          printf '%s\n' "$APT_GPG_PRIVATE_KEY" | gpg --batch --import
          printf '%s\n' "$APT_GPG_OWNERTRUST"   | gpg --batch --import-ownertrust
          gpg --list-secret-keys --keyid-format LONG
  
      # 5) gh-pages 브랜치를 worktree로 붙임 (이 디렉터리에서 커밋/푸시)
      - name: Prepare gh-pages worktree
        run: |
          git fetch origin gh-pages:gh-pages
          git worktree add gh-pages-wt gh-pages
  
      # 6) repo 생성 (gh-pages-wt/repo에 생성)
      - name: Publish APT repo into gh-pages ./repo
        run: |
          chmod +x packaging/server/rootfs/scripts/apt_repo_publish.sh
          ls -al dist
  
          # gh-pages 쪽 repo 폴더는 매번 새로(원하는 동작이면)
          rm -rf gh-pages-wt/repo
          mkdir -p gh-pages-wt/repo
  
          for deb in dist/*.deb; do
            echo "[PUBLISH] $deb"
            packaging/server/rootfs/scripts/apt_repo_publish.sh "$deb" gh-pages-wt/repo
          done
  
          # index.html도 항상 유지하고 싶으면(gh-pages 루트)
          if [ ! -f gh-pages-wt/index.html ]; then
            echo "# Tunneler APT Repo" > gh-pages-wt/index.html
          fi
  
      # 7) gh-pages에 커밋/푸시
      - name: Commit & push gh-pages
        working-directory: gh-pages-wt
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
  
          git add repo index.html
          git status
  
          # 변경 없으면 종료
          git commit -m "apt: publish ${GITHUB_REF_NAME}" || exit 0
          git push origin gh-pages
  

